{% extends "base.html" %}

{% block content %}

    {% load static %} <!-- neither you load static-tag in base.html, you must load static-tag here again -->
    

    <div class="title">
        記事編集
    </div>
    
    {% if form.errors %}
        <div style="color: red;">
            {{ form.errors }}
        </div>
    {% endif %}
    {% if messages %}
        <div style="color: rgb(123, 0, 255);">
            {{ messages }}
        </div>
    {% endif %}
    {% if form.non_field_errors %}
        <div style="color: rgb(0, 0, 0);">
            {{ form.non_field_errors }}
        </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data" style="width: 80%; margin: 0 auto;" action="{% url 'articles:edit' %}">
        {% csrf_token %}
        <div style="width: 100%; background-color: aliceblue; border:3px solid black; border-radius: 10px; height: 200px; display: flex; flex-direction: column; align-items: center;" id="drop-area">
            <div style="margin-top: auto;"><i class="bi bi-image"></i></div>
            <div style="margin-bottom: auto;" class="img-form-message">画像をアップロード</div>
            {{ form.header_img_url }}
        </div>

        <div>
            <!-- <div>記事タイトル</div> -->
            {{ form.title }}
        </div>

        <div style="display: flex;">
            <div>
                <div>カテゴリ</div>
                {{ form.category }}
            </div>
            <div>
                <div>タグ</div>
            </div>
        </div>

        <div>
            <div>本文</div>
            {{ form.content }}
        </div>
        <button type="submit">作成</button>
    </form>

    <style>
        .article_title {
            font-size: 20px;
            font-weight: bold;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            border: none;
        }
        .markdownx {
            display: flex;
            width: 100%;
            flex-direction: row;
        }
        .markdownx .markdownx-editor {
            resize: none;
            height: 500px;
            /* overflow: scroll; */
            min-height: 500px;
            width: 50%;
        }
        .markdownx .markdownx-preview {
            width: 50%;
            height: 500px;
            /* overflow: scroll; */
            min-height: 500px;
        }
        #drop-area input {
            opacity: 0;
        }
    </style>

    <script>
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('id_header_img_url');

        // 添付した画像ファイルを表示する関数
        function handleFile(imgFIle) {
            const reader = new FileReader();

            reader.readAsDataURL(imgFIle);
            reader.onload = (e) => {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.alt = 'Uploaded Image';
                img.style.height = '100%';
                dropArea.appendChild(img);
                dropArea.querySelector('.img-form-message').style.display = 'none';
            }

            // 画像フォーム内の要素を非表示にする
            dropArea.querySelector('.bi-image').style.display = 'none';
            dropArea.querySelector('#id_header_img_url').style.display = 'none';
        }

        // エクスプローラーでのファイル選択時の処理
        fileInput.addEventListener('change', (e) => {
            const imgFile = e.target.files[0];
            if (imgFile && imgFile.type.startsWith('image/')) {
                handleFile(imgFile);
            } else {
                fileInput.value = '';
                alert('画像ファイルを選択してください');
            }
        });

        // ドラッグ&ドロップ時の処理
        dropArea.addEventListener('drop', (e) => {
 
            // input要素にファイルをセットするためのDataTransferオブジェクトを作成
            const imgFile = e.dataTransfer.files[0];
            const dataTransfer = new DataTransfer();

            // 選択したファイルが画像ファイルかどうかを判定
            if (imgFile && imgFile.type.startsWith('image/')) {
                // input要素にファイルをセット
                dataTransfer.items.add(imgFile);
                fileInput.files = dataTransfer.files;
                handleFile(imgFile);
            } else {
                alert('画像ファイルを選択してください');
            }
        }) 

        dropArea.addEventListener('click', () => {
            fileInput.click();
        });

    </script>



{% endblock %}